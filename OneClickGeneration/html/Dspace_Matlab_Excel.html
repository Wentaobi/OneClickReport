
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>CONTROL UNIT TEST</title><meta name="generator" content="MATLAB 9.1"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2018-09-13"><meta name="DC.source" content="Dspace_Matlab_Excel.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>CONTROL UNIT TEST</h1><!--introduction--><p>Revision 2.0 This script is to show figures, charts, tables, plottings to test control algorithm, vehicle behavior</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">INITIALIZE MATLAB WORKSPACE</a></li><li><a href="#2">WORKSPACE ENVIRONMENT</a></li><li><a href="#3">DATA TYPE</a></li><li><a href="#4">VARIABLES</a></li><li><a href="#5">INDEX SEARCHING</a></li><li><a href="#6">EXCEL SHEETS LAYOUT DEFINE</a></li><li><a href="#7">TABLE LAYOUT DEFINE</a></li><li><a href="#8">FEED DATA TO EXCEL</a></li><li><a href="#9">FIGURE GENERATION</a></li><li><a href="#10">FUNCTION 1: STATICS CALCULATION</a></li><li><a href="#11">FUNCTION 2: TRIGGER CHECK</a></li><li><a href="#12">FUNCTION 3: DATA ANALYSIS IN FOGURE</a></li></ul></div><h2 id="1">INITIALIZE MATLAB WORKSPACE</h2><pre class="codeinput">clear;clc;close <span class="string">all</span>;
</pre><h2 id="2">WORKSPACE ENVIRONMENT</h2><p>Define object filename, filepath and other varibles needed, etc...</p><pre class="codeinput">filename = <span class="string">'testdata.xlsx'</span>;
filepath =  <span class="string">'C:\Users\dj5jgf\Aptiv\Autonomous Program - software_architecture\Controls Block _ Scrum Team Folder\1.0 OTTO_Platform\Otto_Test_Data\Test_Data\08_23_2018_Fowlerville\'</span>;
mat_name_0 =  <span class="string">'Binary101_35mph'</span>;
</pre><h2 id="3">DATA TYPE</h2><p>Define string, array, cell ...</p><pre class="codeinput">string = <span class="string">'Bin01'</span>;
var_cell = {};
d0 = load([filepath mat_name_0 <span class="string">'.mat'</span>]);
</pre><h2 id="4">VARIABLES</h2><p>Get variables from MATLAB/SIMULINK - MABX - ControlDesk logging</p><pre class="codeinput">var1 = <span class="string">'&lt;RxPCCrossErrorRD&gt;'</span>;
var2 = <span class="string">'CtrlCmd_FinalReferenceSpeed_mps'</span>;
var3 = <span class="string">'YawRate_RoadWheelAngle'</span>;
var4 = <span class="string">'Roll_Observer_RoadWheelAng'</span>;
var5 = <span class="string">'LatCtrlDesRoadWheelAngleDynCGRollCompensation'</span>;
var6 = <span class="string">'LatCtrlDesRoadWheelAngleDynCG'</span>;
var7 = <span class="string">'LongCtrlAccLqrCrossTrafficDesAccel'</span>;
var8 = <span class="string">'LongCtrlAccLqrCrossWalkDesAccel'</span>;
var9 = <span class="string">'LongCtrlAccLqrCutInDesAccel'</span>;
var10 = <span class="string">'LongCtrlAccLqrPrimaryDesAccel'</span>;
var11 = <span class="string">'&lt;IsManual&gt;'</span>;
<span class="comment">% Pre-allocate variables as placeholder</span>
var1_index = 0;
var2_index = 0;
var3_index = 0;
var4_index = 0;
var5_index = 0;
var6_index = 0;
var7_index = 0;
var8_index = 0;
var9_index = 0;
var10_index = 0;
</pre><h2 id="5">INDEX SEARCHING</h2><p>Find variable index in the Mat file, ps: search last one to rreplace if have multiple same names inside</p><pre class="codeinput"><span class="keyword">for</span> j = 1:length(d0.(string).Y)
    <span class="keyword">if</span> strcmp(d0.(string).Y(j).Name, var1)
        var1_index = j;
        datapoint1 = [d0.(string).Y(j).Data(1)];
    <span class="keyword">elseif</span> strcmp(d0.(string).Y(j).Name, var2)
        var2_index = j;
        datapoint2 = [d0.(string).Y(j).Data(1)];
    <span class="keyword">elseif</span> strcmp(d0.(string).Y(j).Name, var3)
        var3_index = j;
        datapoint3 = [d0.(string).Y(j).Data(1)];
    <span class="keyword">elseif</span> strcmp(d0.(string).Y(j).Name, var4)
        var4_index = j;
        datapoint4 = [d0.(string).Y(j).Data(1)];
    <span class="keyword">elseif</span> strcmp(d0.(string).Y(j).Name, var5)
        var5_index = j;
        datapoint5 = [d0.(string).Y(j).Data(1)];
    <span class="keyword">elseif</span> strcmp(d0.(string).Y(j).Name, var6)
        var6_index = j;
        datapoint6 = [d0.(string).Y(j).Data(1)];
    <span class="keyword">elseif</span> strcmp(d0.(string).Y(j).Name, var7)
        var7_index = j;
        datapoint7 = [d0.(string).Y(j).Data(1)];
    <span class="keyword">elseif</span> strcmp(d0.(string).Y(j).Name, var8)
        var8_index = j;
        datapoint8 = [d0.(string).Y(j).Data(1)];
    <span class="keyword">elseif</span> strcmp(d0.(string).Y(j).Name, var9)
        var9_index = j;
        datapoint9 = [d0.(string).Y(j).Data(1)];
    <span class="keyword">elseif</span> strcmp(d0.(string).Y(j).Name, var10)
        var10_index = j;
        datapoint10 = [d0.(string).Y(j).Data(1)];
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2 id="6">EXCEL SHEETS LAYOUT DEFINE</h2><p>Define separate sheets names, rows, columns</p><pre class="codeinput">index_tab = [var1_index, var2_index, var3_index, var4_index, var5_index, <span class="keyword">...</span>
             var6_index, var7_index, var8_index, var9_index, var10_index];
disp(index_tab);
rows = {<span class="string">'min'</span>; <span class="string">'max'</span>; <span class="string">'avg'</span>; <span class="string">'std dev'</span>};
sheet1 = <span class="string">'Summary'</span>;
sheet2 = <span class="string">'Lateral'</span>;
sheet3 = <span class="string">'Longitudinal'</span>;
sheet4 = <span class="string">'YawRate'</span>;
sheet5 = <span class="string">'RollObserver'</span>;
sheet6 = <span class="string">'RollCompensation'</span>;
sheet7 = <span class="string">'DynCG'</span>;
sheet8 = <span class="string">'CrossTraffic'</span>;
sheet9 = <span class="string">'CrossWalk'</span>;
sheet10 = <span class="string">'CutInDesAccel'</span>;
sheet11 = <span class="string">'PrimaryDesAccel'</span>;
sheet12 = <span class="string">'&lt;IsManual&gt;'</span>;
sheet = {sheet1, sheet2, sheet3, sheet4, sheet5, sheet6, sheet7, <span class="keyword">...</span>
         sheet8, sheet9, sheet10};

gap = floor(length(d0.(string).Y(1).Data)/10);
</pre><pre class="codeoutput">    34    78    50    49    43    39   134   138   142   158

</pre><h2 id="7">TABLE LAYOUT DEFINE</h2><p>Pre-allocate variables as placeholder</p><pre class="codeinput">datapoint1 = [];
datapoint2 = [];
datapoint3 = [];
datapoint4 = [];
datapoint5 = [];
datapoint6 = [];
datapoint7 = [];
datapoint8 = [];
datapoint9 = [];
datapoint10 = [];
<span class="comment">% Find variable index in the Mat file</span>
<span class="keyword">for</span> i= 1:length(index_tab)
    datapoint1 = [datapoint1 d0.(string).Y(index_tab(i)).Data(1*gap)];
    datapoint2 = [datapoint2 d0.(string).Y(index_tab(i)).Data(2*gap)];
    datapoint3 = [datapoint3 d0.(string).Y(index_tab(i)).Data(3*gap)];
    datapoint4 = [datapoint4 d0.(string).Y(index_tab(i)).Data(4*gap)];
    datapoint5 = [datapoint5 d0.(string).Y(index_tab(i)).Data(5*gap)];
    datapoint6 = [datapoint6 d0.(string).Y(index_tab(i)).Data(6*gap)];
    datapoint7 = [datapoint7 d0.(string).Y(index_tab(i)).Data(7*gap)];
    datapoint8 = [datapoint8 d0.(string).Y(index_tab(i)).Data(8*gap)];
    datapoint9 = [datapoint9 d0.(string).Y(index_tab(i)).Data(9*gap)];
    datapoint10 = [datapoint10 d0.(string).Y(index_tab(i)).Data(10*gap)];
<span class="keyword">end</span>
shu = {sheet2;sheet3;sheet4;sheet5;sheet6;sheet7;sheet8;sheet9;sheet10;sheet11};

T = table(datapoint1.',datapoint2.',datapoint3.',datapoint4.',datapoint5.',datapoint6.',<span class="keyword">...</span>
    datapoint7.',datapoint8.',datapoint9.',datapoint10.',<span class="string">'RowNames'</span>,shu)
writetable(T,<span class="string">'testdata.xlsx'</span>,<span class="string">'Sheet'</span>,1,<span class="string">'WriteRowNames'</span>,true);
</pre><pre class="codeoutput">
T = 

                           Var1          Var2          Var3          Var4           Var5           Var6          Var7          Var8           Var9          Var10   
                        __________    __________    __________    ___________    ___________    __________    __________    ___________    ___________    __________

    Lateral                  -0.03        -0.135         0.025          -0.08           0.66        -0.085        -0.085         -0.005          -0.03         0.015
    Longitudinal            15.635        15.635        15.635         15.635         15.635        15.635        15.635         15.635         15.635        15.635
    YawRate               0.012093      0.012873     0.0054646    -0.00039091    -0.00028955     0.0097418      0.011346     -5.936e-18    -5.9272e-18      0.010119
    RollObserver        -0.0030124    -0.0030124    -0.0023132    -0.00016137     -0.0011204    -0.0036044    -0.0024195     -0.0010757    -0.00064562    -0.0039815
    RollCompensation       -0.0014       -0.0014     -0.001075       -7.5e-05      -0.000475     -0.001675     -0.001125        -0.0005        -0.0003      -0.00185
    DynCG                0.0085878      0.012215     0.0034338    -0.00036983    -4.7506e-05      0.009003      0.010573    -0.00092263     0.00086082     0.0056577
    CrossTraffic            9.8044        9.7916        9.8058         9.8117         8.2275        9.7898        9.8207          9.807         9.8115        9.7809
    CrossWalk               9.8314        9.8186        9.8328         9.8387         8.2494        9.8168        9.8478         9.8341         9.8386        9.8079
    CutInDesAccel           11.237        11.231        11.239         11.241         9.2259        11.226        11.246         11.245         11.241         11.22
    PrimaryDesAccel         11.237        11.231        11.239         11.241         9.2259        11.226        11.246         11.245         11.241         11.22

</pre><h2 id="8">FEED DATA TO EXCEL</h2><p>meter/s to mile/h</p><pre class="codeinput">n = 2.24;
<span class="keyword">for</span> i= 1:length(sheet)
    <span class="keyword">if</span> i&gt;= 2
        i = i -1;
        <span class="comment">% fixed pos for spread sheet</span>
        A1_pos = <span class="string">'B1'</span>;
        B1_pos = <span class="string">'A2:A5'</span>;
        x = d0.(string).Y(index_tab(i)).Data;
        [min_x, max_x, avg_x, std_x] = cal_x(x);
        columns = {<span class="string">'Units m/s'</span>,<span class="string">'Units mph'</span>; min_x,min_x*n; max_x,max_x*n;<span class="keyword">...</span>
                                            avg_x,avg_x*n; std_x,std_x*n};
        <span class="comment">% spread sheet</span>
        xlswrite(filename,columns,sheet{i+1},A1_pos)
        xlswrite(filename,rows,sheet{i+1},B1_pos)
        <span class="comment">% summary sheet</span>
        A_sumpos = strcat(<span class="string">'A'</span>, num2str(i*6-5));
        A_sumrange = strcat(<span class="string">'A'</span>, num2str(i*6-4), <span class="string">':A'</span>, num2str(i*6-1));
        B_sumrange = strcat(<span class="string">'B'</span>, num2str(i*6-5));
        xlswrite(filename,{sheet{i+1}},sheet{1},A_sumpos);
        xlswrite(filename,columns,sheet{1},B_sumrange)
        xlswrite(filename,rows,sheet{1},A_sumrange)
        i = i + 1;
    <span class="keyword">end</span>
<span class="keyword">end</span>

xlswrite(filename,{<span class="string">'Take-over'</span>},<span class="string">'Take-over'</span>,<span class="string">'A1'</span>)
xlswrite(filename,{<span class="string">'Take-over times'</span>,cal_m(d0.(string).Y(1).Data);},<span class="string">'Take-over'</span>,<span class="string">'B1'</span>)
</pre><h2 id="9">FIGURE GENERATION</h2><pre class="codeinput">plotting;
</pre><h2 id="10">FUNCTION 1: STATICS CALCULATION</h2><p>Figure out min, max, average, std dev ...</p><pre class="codeinput"><span class="keyword">function</span> [min_x, max_x, avg_x, std_x] = cal_x(x)
min_x = min(x);
max_x = max(x);
avg_x = mean(x);
std_x = std(x);
<span class="keyword">end</span>
</pre><h2 id="11">FUNCTION 2: TRIGGER CHECK</h2><p>Find how many times driver take over from Auto mode to MANUAL mode</p><pre class="codeinput"><span class="keyword">function</span> manual = cal_m(m)
manual = diff(m);
manual = sum(manual(:)==1);
<span class="keyword">end</span>
</pre><h2 id="12">FUNCTION 3: DATA ANALYSIS IN FOGURE</h2><p>Plot some feaures and analyze them</p><pre class="codeinput"><span class="keyword">function</span> plotting
mu = 0;
sigma = 0.5;
num = 20000;
range = -3.5:0.05:3.5;
range = range*sigma;
string1 = <span class="string">'Lateral error'</span>;
xlab = strcat(string1, <span class="string">'position (m)'</span> );
len = 0.64;
<span class="comment">% Plotting/ Figure setting</span>
hfig = figure(1);
set(hfig, <span class="string">'Position'</span>, [700 400 1200 600]);
x = mu + (sigma) * randn(num,1);
[counter, center] = hist(x, range);
plot(center, counter/num,<span class="string">'-b'</span>,<span class="string">'LineWidth'</span>,2);
hold <span class="string">on</span>;
plot(center, counter*0.7/num,<span class="string">'-g'</span>,<span class="string">'LineWidth'</span>,2);
plot(center, counter*0.75/num,<span class="string">'-r'</span>,<span class="string">'LineWidth'</span>,2);
len_p = max(counter/num)*len;
ax = gca;
ax.YGrid=<span class="string">'on'</span>;
ax.FontSize = 14;
<span class="comment">% Text/axis</span>
plot([-sigma, -sigma], [0, len_p],<span class="string">'-m'</span>,<span class="string">'LineWidth'</span>,2);
plot([-2*sigma, -2*sigma], [0, len_p],<span class="string">'-c'</span>,<span class="string">'LineWidth'</span>,2);
plot([-3*sigma, -3*sigma], [0, len_p],<span class="string">'-y'</span>,<span class="string">'LineWidth'</span>,2);
legend(string1, <span class="string">'Left'</span>, <span class="string">'Right'</span>,<span class="string">'1 CL'</span>, <span class="string">'2 CL'</span>,<span class="string">'3 CL'</span>);
plot([sigma, sigma], [0, len_p],<span class="string">'-m'</span>,<span class="string">'LineWidth'</span>,2);
plot([2*sigma, 2*sigma], [0, len_p],<span class="string">'-c'</span>,<span class="string">'LineWidth'</span>,2);
plot([3*sigma, 3*sigma], [0, len_p],<span class="string">'-y'</span>,<span class="string">'LineWidth'</span>,2);
text(-1.9,0.024,<span class="string">'Overall'</span>,<span class="string">'Color'</span>,<span class="string">'black'</span>,<span class="string">'FontSize'</span>,13)
text(-1.9,0.023,<span class="string">'LC on Ave Speed 60MPH'</span>,<span class="string">'Color'</span>,<span class="string">'black'</span>,<span class="string">'FontSize'</span>,13);
text(-1.9,0.022,<span class="string">'LC on Dist./Total 2000/2500 Mile'</span>,<span class="string">'Color'</span>,<span class="string">'black'</span>,<span class="string">'FontSize'</span>,13);
text(-1.9,0.021,<span class="string">'LC on time percentage 85.6%'</span>,<span class="string">'Color'</span>,<span class="string">'black'</span>,<span class="string">'FontSize'</span>,13);
text(-1.75,0.020,<span class="string">'RMSE  1\sigma%   2\sigma%   3\sigma%   LC time%'</span>,<span class="string">'Color'</span>,<span class="string">'black'</span>,<span class="string">'FontSize'</span>,13);
text(-1.75,0.019,<span class="string">'--------    ------   ------   ------   ------------'</span>,<span class="string">'Color'</span>,<span class="string">'black'</span>,<span class="string">'FontSize'</span>,13);
text(-1.9,0.018,<span class="string">'All    0.125    91.2   99.0   100.0  100(45.91 hour)'</span>,<span class="string">'Color'</span>,<span class="string">'black'</span>,<span class="string">'FontSize'</span>,13);
text(-1.9,0.017,<span class="string">'Str    0.097    95.5   99.8   100.0  69.1'</span>,<span class="string">'Color'</span>,<span class="string">'blue'</span>,<span class="string">'FontSize'</span>,13);
text(-1.9,0.016,<span class="string">'Lf      0.170    81.7   97.4   99.9   15.8'</span>,<span class="string">'Color'</span>,<span class="string">'green'</span>,<span class="string">'FontSize'</span>,13);
text(-1.9,0.015,<span class="string">'Rt      0.173    81.1   96.8   99.9   15.0'</span>,<span class="string">'Color'</span>,<span class="string">'red'</span>,<span class="string">'FontSize'</span>,13);
text(-1.9,0.014,<span class="string">'LC on rain  1.26%'</span>,<span class="string">'Color'</span>,<span class="string">'black'</span>,<span class="string">'FontSize'</span>,13);
text(-1.9,0.013,<span class="string">'LC on night 7.96%'</span>,<span class="string">'Color'</span>,<span class="string">'black'</span>,<span class="string">'FontSize'</span>,13);
<span class="comment">%grid on;</span>
hold <span class="string">off</span>;
xlabel(xlab);
ylabel(<span class="string">'Normalized Samples, prob%'</span>);
title(<span class="string">'Lane Error Histogram based on Path'</span>,<span class="string">'Color'</span>, <span class="string">'r'</span>);
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="Dspace_Matlab_Excel_01.png" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2016b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% CONTROL UNIT TEST 
% Revision 2.0
% This script is to show figures, charts, tables, plottings to 
% test control algorithm, vehicle behavior

%% INITIALIZE MATLAB WORKSPACE
clear;clc;close all;

%% WORKSPACE ENVIRONMENT
% Define object filename, filepath and other varibles needed, etc... 

filename = 'testdata.xlsx';
filepath =  'C:\Users\dj5jgf\Aptiv\Autonomous Program - software_architecture\Controls Block _ Scrum Team Folder\1.0 OTTO_Platform\Otto_Test_Data\Test_Data\08_23_2018_Fowlerville\';
mat_name_0 =  'Binary101_35mph';

%% DATA TYPE
% Define string, array, cell ...
string = 'Bin01';
var_cell = {};
d0 = load([filepath mat_name_0 '.mat']);

%% VARIABLES  
% Get variables from MATLAB/SIMULINK - MABX - ControlDesk logging
var1 = '<RxPCCrossErrorRD>';
var2 = 'CtrlCmd_FinalReferenceSpeed_mps';
var3 = 'YawRate_RoadWheelAngle';
var4 = 'Roll_Observer_RoadWheelAng';
var5 = 'LatCtrlDesRoadWheelAngleDynCGRollCompensation';
var6 = 'LatCtrlDesRoadWheelAngleDynCG';
var7 = 'LongCtrlAccLqrCrossTrafficDesAccel';
var8 = 'LongCtrlAccLqrCrossWalkDesAccel';
var9 = 'LongCtrlAccLqrCutInDesAccel';
var10 = 'LongCtrlAccLqrPrimaryDesAccel';
var11 = '<IsManual>';
% Pre-allocate variables as placeholder
var1_index = 0;
var2_index = 0;
var3_index = 0;
var4_index = 0;
var5_index = 0;
var6_index = 0;
var7_index = 0;
var8_index = 0;
var9_index = 0;
var10_index = 0;
%% INDEX SEARCHING 
% Find variable index in the Mat file, ps: search last one to rreplace if 
% have multiple same names inside
for j = 1:length(d0.(string).Y)
    if strcmp(d0.(string).Y(j).Name, var1)
        var1_index = j;
        datapoint1 = [d0.(string).Y(j).Data(1)];
    elseif strcmp(d0.(string).Y(j).Name, var2)
        var2_index = j;
        datapoint2 = [d0.(string).Y(j).Data(1)];
    elseif strcmp(d0.(string).Y(j).Name, var3)
        var3_index = j;
        datapoint3 = [d0.(string).Y(j).Data(1)];
    elseif strcmp(d0.(string).Y(j).Name, var4)
        var4_index = j;
        datapoint4 = [d0.(string).Y(j).Data(1)];
    elseif strcmp(d0.(string).Y(j).Name, var5)
        var5_index = j;
        datapoint5 = [d0.(string).Y(j).Data(1)];
    elseif strcmp(d0.(string).Y(j).Name, var6)
        var6_index = j;
        datapoint6 = [d0.(string).Y(j).Data(1)];
    elseif strcmp(d0.(string).Y(j).Name, var7)
        var7_index = j;
        datapoint7 = [d0.(string).Y(j).Data(1)];
    elseif strcmp(d0.(string).Y(j).Name, var8)
        var8_index = j;
        datapoint8 = [d0.(string).Y(j).Data(1)];
    elseif strcmp(d0.(string).Y(j).Name, var9)
        var9_index = j;
        datapoint9 = [d0.(string).Y(j).Data(1)];
    elseif strcmp(d0.(string).Y(j).Name, var10)
        var10_index = j; 
        datapoint10 = [d0.(string).Y(j).Data(1)];
    end          
end
%% EXCEL SHEETS LAYOUT DEFINE
% Define separate sheets names, rows, columns
index_tab = [var1_index, var2_index, var3_index, var4_index, var5_index, ...
             var6_index, var7_index, var8_index, var9_index, var10_index];
disp(index_tab);
rows = {'min'; 'max'; 'avg'; 'std dev'};
sheet1 = 'Summary';
sheet2 = 'Lateral';
sheet3 = 'Longitudinal';
sheet4 = 'YawRate';
sheet5 = 'RollObserver';
sheet6 = 'RollCompensation';
sheet7 = 'DynCG';
sheet8 = 'CrossTraffic';
sheet9 = 'CrossWalk';
sheet10 = 'CutInDesAccel';
sheet11 = 'PrimaryDesAccel';
sheet12 = '<IsManual>';
sheet = {sheet1, sheet2, sheet3, sheet4, sheet5, sheet6, sheet7, ...
         sheet8, sheet9, sheet10};

gap = floor(length(d0.(string).Y(1).Data)/10);
%% TABLE LAYOUT DEFINE
% Pre-allocate variables as placeholder 
datapoint1 = [];
datapoint2 = [];
datapoint3 = [];
datapoint4 = [];
datapoint5 = [];
datapoint6 = [];
datapoint7 = [];
datapoint8 = [];
datapoint9 = [];
datapoint10 = [];
% Find variable index in the Mat file
for i= 1:length(index_tab)
    datapoint1 = [datapoint1 d0.(string).Y(index_tab(i)).Data(1*gap)];
    datapoint2 = [datapoint2 d0.(string).Y(index_tab(i)).Data(2*gap)];
    datapoint3 = [datapoint3 d0.(string).Y(index_tab(i)).Data(3*gap)];
    datapoint4 = [datapoint4 d0.(string).Y(index_tab(i)).Data(4*gap)];
    datapoint5 = [datapoint5 d0.(string).Y(index_tab(i)).Data(5*gap)];
    datapoint6 = [datapoint6 d0.(string).Y(index_tab(i)).Data(6*gap)];
    datapoint7 = [datapoint7 d0.(string).Y(index_tab(i)).Data(7*gap)];
    datapoint8 = [datapoint8 d0.(string).Y(index_tab(i)).Data(8*gap)];
    datapoint9 = [datapoint9 d0.(string).Y(index_tab(i)).Data(9*gap)];
    datapoint10 = [datapoint10 d0.(string).Y(index_tab(i)).Data(10*gap)];
end
shu = {sheet2;sheet3;sheet4;sheet5;sheet6;sheet7;sheet8;sheet9;sheet10;sheet11};

T = table(datapoint1.',datapoint2.',datapoint3.',datapoint4.',datapoint5.',datapoint6.',...
    datapoint7.',datapoint8.',datapoint9.',datapoint10.','RowNames',shu)
writetable(T,'testdata.xlsx','Sheet',1,'WriteRowNames',true);   
%% FEED DATA TO EXCEL
% meter/s to mile/h
n = 2.24; 
for i= 1:length(sheet)
    if i>= 2
        i = i -1;
        % fixed pos for spread sheet
        A1_pos = 'B1';
        B1_pos = 'A2:A5';
        x = d0.(string).Y(index_tab(i)).Data;
        [min_x, max_x, avg_x, std_x] = cal_x(x);
        columns = {'Units m/s','Units mph'; min_x,min_x*n; max_x,max_x*n;...
                                            avg_x,avg_x*n; std_x,std_x*n};
        % spread sheet
        xlswrite(filename,columns,sheet{i+1},A1_pos) 
        xlswrite(filename,rows,sheet{i+1},B1_pos) 
        % summary sheet
        A_sumpos = strcat('A', num2str(i*6-5));
        A_sumrange = strcat('A', num2str(i*6-4), ':A', num2str(i*6-1));
        B_sumrange = strcat('B', num2str(i*6-5));
        xlswrite(filename,{sheet{i+1}},sheet{1},A_sumpos);
        xlswrite(filename,columns,sheet{1},B_sumrange) 
        xlswrite(filename,rows,sheet{1},A_sumrange)  
        i = i + 1;
    end
end

xlswrite(filename,{'Take-over'},'Take-over','A1') 
xlswrite(filename,{'Take-over times',cal_m(d0.(string).Y(1).Data);},'Take-over','B1') 
%% FIGURE GENERATION
plotting;
%% FUNCTION 1: STATICS CALCULATION
% Figure out min, max, average, std dev ...
function [min_x, max_x, avg_x, std_x] = cal_x(x)
min_x = min(x);
max_x = max(x);
avg_x = mean(x);
std_x = std(x);
end
%% FUNCTION 2: TRIGGER CHECK
% Find how many times driver take over from Auto mode to MANUAL mode
function manual = cal_m(m)
manual = diff(m);
manual = sum(manual(:)==1);
end
%% FUNCTION 3: DATA ANALYSIS IN FOGURE
% Plot some feaures and analyze them
function plotting
mu = 0;
sigma = 0.5;
num = 20000;
range = -3.5:0.05:3.5;
range = range*sigma;
string1 = 'Lateral error';
xlab = strcat(string1, 'position (m)' );
len = 0.64;
% Plotting/ Figure setting
hfig = figure(1);
set(hfig, 'Position', [700 400 1200 600]);
x = mu + (sigma) * randn(num,1);
[counter, center] = hist(x, range);
plot(center, counter/num,'-b','LineWidth',2);
hold on;
plot(center, counter*0.7/num,'-g','LineWidth',2);
plot(center, counter*0.75/num,'-r','LineWidth',2);
len_p = max(counter/num)*len;
ax = gca;
ax.YGrid='on';
ax.FontSize = 14;
% Text/axis
plot([-sigma, -sigma], [0, len_p],'-m','LineWidth',2);
plot([-2*sigma, -2*sigma], [0, len_p],'-c','LineWidth',2);
plot([-3*sigma, -3*sigma], [0, len_p],'-y','LineWidth',2);
legend(string1, 'Left', 'Right','1 CL', '2 CL','3 CL');
plot([sigma, sigma], [0, len_p],'-m','LineWidth',2);
plot([2*sigma, 2*sigma], [0, len_p],'-c','LineWidth',2);
plot([3*sigma, 3*sigma], [0, len_p],'-y','LineWidth',2);
text(-1.9,0.024,'Overall','Color','black','FontSize',13)
text(-1.9,0.023,'LC on Ave Speed 60MPH','Color','black','FontSize',13);
text(-1.9,0.022,'LC on Dist./Total 2000/2500 Mile','Color','black','FontSize',13);
text(-1.9,0.021,'LC on time percentage 85.6%','Color','black','FontSize',13);
text(-1.75,0.020,'RMSE  1\sigma%   2\sigma%   3\sigma%   LC time%','Color','black','FontSize',13);
text(-1.75,0.019,'REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH    REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH   REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH   REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH   REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH','Color','black','FontSize',13);
text(-1.9,0.018,'All    0.125    91.2   99.0   100.0  100(45.91 hour)','Color','black','FontSize',13);
text(-1.9,0.017,'Str    0.097    95.5   99.8   100.0  69.1','Color','blue','FontSize',13);
text(-1.9,0.016,'Lf      0.170    81.7   97.4   99.9   15.8','Color','green','FontSize',13);
text(-1.9,0.015,'Rt      0.173    81.1   96.8   99.9   15.0','Color','red','FontSize',13);
text(-1.9,0.014,'LC on rain  1.26%','Color','black','FontSize',13);
text(-1.9,0.013,'LC on night 7.96%','Color','black','FontSize',13);
%grid on;
hold off;
xlabel(xlab);
ylabel('Normalized Samples, prob%');
title('Lane Error Histogram based on Path','Color', 'r');
end

##### SOURCE END #####
--></body></html>